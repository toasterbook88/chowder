#!/usr/bin/env bash
# Health check script for monitoring Clawdbot + Ollama

REPO_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$REPO_DIR"

echo "ü¶û Health Check - $(date)"
echo "========================"

ISSUES=0

# Check Ollama
echo "Ollama Status:"
if pgrep -f "ollama serve" >/dev/null; then
    echo "  ‚úÖ Process running"
else
    echo "  ‚ùå Process not running"
    ((ISSUES++))
fi

if curl -s --max-time 2 http://127.0.0.1:11434/api/tags >/dev/null; then
    echo "  ‚úÖ API responding"
    MODEL_COUNT=$(curl -s http://127.0.0.1:11434/api/tags | jq -r '.models | length' 2>/dev/null || echo "0")
    echo "  üìä Models available: $MODEL_COUNT"
else
    echo "  ‚ùå API not responding"
    ((ISSUES++))
fi

# Check Clawdbot Gateway
echo ""
echo "Clawdbot Gateway Status:"
if pgrep -f "clawdbot gateway" >/dev/null; then
    echo "  ‚úÖ Process running"
else
    echo "  ‚ùå Process not running"
    ((ISSUES++))
fi

if curl -s --max-time 2 http://127.0.0.1:18789/ >/dev/null; then
    echo "  ‚úÖ Web interface responding"
else
    echo "  ‚ùå Web interface not responding"
    ((ISSUES++))
fi

# Check ports
echo ""
echo "Port Status:"
if lsof -i :18789 >/dev/null 2>&1; then
    echo "  ‚úÖ Port 18789 (gateway) in use"
else
    echo "  ‚ùå Port 18789 (gateway) free"
    ((ISSUES++))
fi

if lsof -i :11434 >/dev/null 2>&1; then
    echo "  ‚úÖ Port 11434 (Ollama) in use"
else
    echo "  ‚ùå Port 11434 (Ollama) free"
    ((ISSUES++))
fi

# Summary
echo ""
if [ $ISSUES -eq 0 ]; then
    echo "üéâ All systems healthy!"
else
    echo "‚ö†Ô∏è  $ISSUES issues detected"
    echo ""
    echo "Quick fixes:"
    [ $ISSUES -gt 0 ] && echo "  Run: bash scripts/setup    # Auto-setup everything"
    [ $ISSUES -gt 0 ] && echo "  Run: bash scripts/start    # Start services"
fi